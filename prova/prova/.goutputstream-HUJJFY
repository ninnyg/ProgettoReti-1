var express = require('express');
//var router = express.Router();
var app = express();
var request = require('request');
var session = require('express-session');

app.use(express.static('/home/biar/Desktop/prova/prova/public'));
app.use(express.static('/home/biar/Desktop/prova/prova/public/stylesheets'));
//app.use(session({secret: 'ssshhhhh'}));

var sessione;

app.get('/', function (req, res) {
   res.sendFile('/home/biar/Desktop/prova/prova/public/prova.html');
});

app.get('/login', function(req,res){
   res.redirect("https://www.facebook.com/dialog/oauth?client_id=469295763275586&redirect_uri=http://localhost:3000/login/confirm");
  });
  
  
app.get('/login/confirm',function(req,res){
    var code=req.query.code;
    console.log("questo è il code:\n");
   console.log(code);
   //var code=getParameterByName('code');
   /*window.alert(code);*/
   var access_token;
   var url="https://graph.facebook.com/v2.3/oauth/access_token?client_id=469295763275586&redirect_uri=http://localhost:3000/login/confirm&client_secret=c70d3441f6a7b19d88f0bea0daadf9d0&code="+code
   request.get(url ,function(error,response,body){
                        if(!error && response.statusCode==200){
                        access_token = JSON.parse(body).access_token;
                        console.log("questo è l' acces_token: \n");
                        console.log(access_token);
                        //exports.TOKEN_FB=access_token;
                        res.redirect('http://localhost:3000/welcomePage');
                        }
                        else{
                            console.log("errore :\n");
                            console.log(error);
                            }
    });
    var email
    request.get("https://graph.facebook.com/me?access_token="+access_token ,function(error,response,body){
                        if(!error && response.statusCode==200){
                        //email= JSON.parse(body);
                        console.log("questo è l' email: \n");
                        console.log(body);
                        }
                        else{
                            console.log("errore :\n");
                            console.log(error);
                            }
    });
    
    sessione=req.session;
    //sessione.email=email;
});
   
app.get('/welcomePage', function (req, res) {
   res.sendFile('/home/biar/Desktop/prova/prova/public/welcome.html');
});

app.get('/logout', function(req, res){
  req.session.destroy(function(){                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
    res.redirect('http://localhost:3000/');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
  });     
});

app.post('/static', function (req, res) {
  res.sendFile('/home/biar/Desktop/prova/prova/public/images/fiore.jpg');
});



app.listen(3000, function () {
  console.log('In ascolto sulla porta 3000!');
});
